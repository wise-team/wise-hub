version: "3.7"
networks:
  vault-net:
    external:
      name: vault-net

services:
  #§ data.config.hub.docker.services.nginx.name + ':'
  nginx:
    image: nginx
    #§ 'container_name: ' + data.config.hub.docker.services.nginx.container
    container_name: wise-hub-serve
    volumes:
      - ./nginx/site.template.conf:/etc/nginx/conf.d/mysite.template:ro
      - .:/srv:ro
    ports:
      - "8080:80"
    environment:
      WISE_ENVIRONMENT_TYPE: development
      #§ 'WISE_SQL_ENDPOINT_URL: ' + data.config.sql.url.production
      WISE_SQL_ENDPOINT_URL: https://sql.wise.vote/
      #§ 'STEEMD_ENDPOINT_URL: ' + data.config.steem.defaultApiUrl
      STEEMD_ENDPOINT_URL: https://api.steemit.com
      STEEMCONNECT_REDIRECT_URI: "https://localhost:8080/"
      DOLLAR: '$$' #enables use of dollar sign in template.conf
    command: /bin/bash -c "envsubst < /etc/nginx/conf.d/mysite.template > /etc/nginx/conf.d/default.conf && cat /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
  
  #§ data.config.hub.docker.services.redis.name + ':'
  redis:
    image: redis:alpine
    #§ 'container_name: ' + data.config.hub.docker.services.redis.container
    container_name: wise-hub-redis
    command: redis-server --appendonly yes
    expose:
      - 6379
    volumes:
      #§ '- ' + data.config.hub.docker.services.redis.volume + ':/data:rw'
      - wise_hub_redis:/data:rw

  #§ d(data.config.hub.docker.services.api.name) + ':'
  api:
    build:
      context: backend
      dockerfile: Dockerfile.api
    #§ 'image: ' + d(data.config.hub.docker.services.api.image)
    image: wise/hub-backend
    command: sh -c "node dist/api/index.js"
    #§ 'container_name: ' + d(data.config.hub.docker.services.api.container)
    container_name: wise-hub-api
    cap_add:
      - IPC_LOCK
    expose:
      - 3000
    volumes:
      - "./vault-dev/vault-dev-config.json:/vault-dev/vault-dev-config.json:ro"
    secrets:
      #§ '- ' + data.config.hub.docker.services.api.secrets.appRoleId
      - hub-api-approle-id
      #§ '- ' + data.config.hub.docker.services.api.secrets.appRoleSecret
      - hub-api-approle-secret
    environment:
      #§ 'VAULT_APPROLE_NAME: ' + data.config.hub.docker.services.api.appRole.role
      VAULT_APPROLE_NAME: wise-hub-api
      #§ 'VAULT_APPROLE_ID_FILE: /run/secrets/' + data.config.hub.docker.services.api.secrets.appRoleId
      VAULT_APPROLE_ID_FILE: /run/secrets/hub-api-approle-id
      #§ 'VAULT_APPROLE_SECRET_FILE: /run/secrets/' + data.config.hub.docker.services.api.secrets.appRoleSecret
      VAULT_APPROLE_SECRET_FILE: /run/secrets/hub-api-approle-secret
      #§ 'REDIS_URL: redis://' + data.config.hub.docker.services.redis.container + ':6379/'
      REDIS_URL: redis://wise-hub-redis:6379/
      WISE_LOG_LEVEL: debug
      WISE_VAULT_URL: "http://vault-dev:8200"
    networks:
      - default
      - vault-net

  #§ d(data.config.hub.docker.services.daemon.name) + ':'
  daemon:
    build: backend
    #§ 'image: ' + d(data.config.hub.docker.services.daemon.image)
    image: wise/hub-backend
    command: sh -c "node dist/daemon/index.js"
    #§ 'container_name: ' + d(data.config.hub.docker.services.daemon.container)
    container_name: wise-hub-daemon
    environment:
      START_FROM_BLOCK: 27172910
      #§ "STEEM_API_URL: \"" + data.config.steem.apis.filter(api => api.get_block === true).map(api => api.url).join(",") + "\""
      STEEM_API_URL: "https://api.steemit.com,https://rpc.buildteam.io"
      #§ 'WISE_SQL_ENDPOINT_URL: ' + data.config.sql.url.production
      WISE_SQL_ENDPOINT_URL: https://sql.wise.vote/
      #§ 'REDIS_URL: redis://' + data.config.hub.docker.services.redis.container + ':6379/'
      REDIS_URL: redis://wise-hub-redis:6379/
      WISE_LOG_LEVEL: debug
    networks:
      - default

  #§ d(data.config.hub.docker.services.publisher.name) + ':'
  publisher:
    build: backend
    #§ 'image: ' + d(data.config.hub.docker.services.publisher.image)
    image: wise/hub-backend
    command: sh -c "node dist/publisher/index.js"
    #§ 'container_name: ' + d(data.config.hub.docker.services.publisher.container)
    container_name: wise-hub-publisher
    cap_add:
      - IPC_LOCK
    secrets:
      #§ '- ' + data.config.hub.docker.services.publisher.secrets.appRoleId
      - hub-publisher-approle-id
      #§ '- ' + data.config.hub.docker.services.publisher.secrets.appRoleSecret
      - hub-publisher-approle-secret
    environment:
      #§ 'VAULT_APPROLE_NAME: ' + data.config.hub.docker.services.publisher.appRole.role
      VAULT_APPROLE_NAME: wise-hub-daemon
      #§ 'VAULT_APPROLE_ID_FILE: /run/secrets/' + data.config.hub.docker.services.publisher.secrets.appRoleId
      VAULT_APPROLE_ID_FILE: /run/secrets/hub-publisher-approle-id
      #§ 'VAULT_APPROLE_SECRET_FILE: /run/secrets/' + data.config.hub.docker.services.publisher.secrets.appRoleSecret
      VAULT_APPROLE_SECRET_FILE: /run/secrets/hub-publisher-approle-secret
      #§ 'REDIS_URL: redis://' + data.config.hub.docker.services.redis.container + ':6379/'
      REDIS_URL: redis://wise-hub-redis:6379/
      WISE_LOG_LEVEL: debug
      WISE_VAULT_URL: "http://vault-dev:8200"
    networks:
      - default
      - vault-net

secrets:
  #§ data.config.hub.docker.services.api.secrets.appRoleId + ':'
  hub-api-approle-id:
    #§ 'file: ./secrets/' + data.config.hub.docker.services.api.secrets.appRoleId
    file: ./secrets/hub-api-approle-id
  #§ data.config.hub.docker.services.api.secrets.appRoleSecret + ':'
  hub-api-approle-secret:
    #§ 'file: ./secrets/' + data.config.hub.docker.services.api.secrets.appRoleSecret
    file: ./secrets/hub-api-approle-secret
  #§ data.config.hub.docker.services.publisher.secrets.appRoleId + ':'
  hub-publisher-approle-id:
    #§ 'file: ./secrets/' + data.config.hub.docker.services.publisher.secrets.appRoleId
    file: ./secrets/hub-publisher-approle-id
  #§ data.config.hub.docker.services.publisher.secrets.appRoleSecret + ':'
  hub-publisher-approle-secret:
    #§ 'file: ./secrets/' + data.config.hub.docker.services.publisher.secrets.appRoleSecret
    file: ./secrets/hub-publisher-approle-secret

volumes:
  #§ data.config.hub.docker.services.redis.volume + ':'
  wise_hub_redis:
