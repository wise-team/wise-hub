version: "3"

services:
  #§ data.config.hub.docker.services.nginx.name + ':'
  nginx:
    image: nginx
    #§ 'container_name: ' + data.config.hub.docker.services.nginx.container
    container_name: wise-hub-serve
    volumes:
      - ./nginx/site.template.conf:/etc/nginx/conf.d/mysite.template:ro
      - .:/srv:ro
    ports:
      - "8080:80"
    environment:
      WISE_ENVIRONMENT_TYPE: development
      #§ 'WISE_SQL_ENDPOINT_URL: ' + data.config.sql.url.production
      WISE_SQL_ENDPOINT_URL: https://sql.wise.vote/
      #§ 'STEEMD_ENDPOINT_URL: ' + data.config.steem.defaultApiUrl
      STEEMD_ENDPOINT_URL: https://api.steemit.com
      STEEMCONNECT_REDIRECT_URI: "https://localhost:8080/"
      DOLLAR: '$$' #enables use of dollar sign in template.conf
    command: /bin/bash -c "envsubst < /etc/nginx/conf.d/mysite.template > /etc/nginx/conf.d/default.conf && cat /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
  
  #§ data.config.hub.docker.services.redis.name + ':'
  redis:
    image: redis:alpine
    #§ 'container_name: ' + data.config.hub.docker.services.redis.container
    container_name: wise-hub-redis
    expose:
      - 6379

  #§ d(data.config.hub.docker.services.api.name) + ':'
  api:
    build:
      context: backend
      dockerfile: Dockerfile.api
    #§ 'image: ' + d(data.config.hub.docker.services.api.image)
    image: wise/hub-api
    # In dev mode this service also initializes dev vault
    command: sh -c "sleep 3 && node dist/vault-dev/init-vault-dev.js && sleep 2 && node dist/api/index.js"
    #§ 'container_name: ' + d(data.config.hub.docker.services.api.container)
    container_name: wise-hub-api
    cap_add:
      - IPC_LOCK
    expose:
      - 3000
    volumes: # because this service initializes dev vault, it needs to write the secrets to proper paths
      #§ '- "./tmp' + data.config.hub.docker.services.api.appRole.secretMount + ':' + data.config.hub.docker.services.api.appRole.secretMount + ':rw"'
      - "./tmp/secret/api-role.json:/secret/api-role.json:rw"
      #§ '- "./tmp' + data.config.hub.docker.services.daemon.appRole.secretMount + ':' + data.config.hub.docker.services.daemon.appRole.secretMount + ':rw"'
      - "./tmp/secret/daemon-role.json:/secret/daemon-role.json:rw"
    environment:
      #§ 'REDIS_URL: redis://' + data.config.hub.docker.services.redis.container + ':6379/'
      REDIS_URL: redis://wise-hub-redis:6379/
      WISE_LOG_LEVEL: debug
      WISE_VAULT_URL: "http://vault-dev:8200"

  #§ d(data.config.hub.docker.services.daemon.name) + ':'
  daemon:
    build:
      context: backend
      dockerfile: Dockerfile.daemon
    #§ 'image: ' + d(data.config.hub.docker.services.daemon.image)
    image: wise/hub-daemon
    command: sh -c "sleep 8 && node dist/daemon/index.js"
    #§ 'container_name: ' + d(data.config.hub.docker.services.daemon.container)
    container_name: wise-hub-daemon
    volumes:
      #§ '- "./tmp' + data.config.hub.docker.services.daemon.appRole.secretMount + ':' + data.config.hub.docker.services.daemon.appRole.secretMount + ':rw"'
      - "./tmp/secret/daemon-role.json:/secret/daemon-role.json:rw"
    cap_add:
      - IPC_LOCK
    environment:
      #§ 'REDIS_URL: redis://' + data.config.hub.docker.services.redis.container + ':6379/'
      REDIS_URL: redis://wise-hub-redis:6379/
      WISE_LOG_LEVEL: debug
      WISE_VAULT_URL: "http://vault-dev:8200"

  vault-dev:
    image: vault
    container_name: vault-dev
    command: vault server -config /vault/config/local.json
    cap_add:
      - IPC_LOCK
    environment:
      - 'VAULT_API_ADDR=http://0.0.0.0:8200'
      - 'VAULT_ADDR=http://127.0.0.1:8200'
      - 'VAULT_LOCAL_CONFIG={"backend": { "inmem": {} }, "default_lease_ttl": "168h", "max_lease_ttl": "720h", "listener": [{"tcp": {"address": "0.0.0.0:8200","tls_disable": 1}}]}'
    ports:
      - 127.0.0.1:8200:8200